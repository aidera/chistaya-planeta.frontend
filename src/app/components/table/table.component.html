<div class="table-wrapper">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>
            <div class="cell-header__container" style="text-align: center">
              <button
                mat-icon-button
                [matMenuTriggerFor]="tableSettings"
                [matTooltip]="'Отображать колонки'"
                [matTooltipPosition]="'above'"
              >
                <span
                  class="icon"
                  [inlineSVG]="
                    displayedColumns &&
                    allDisplayedColumns &&
                    displayedColumns.length === allDisplayedColumns.length
                      ? '../assets/icons/settings.svg'
                      : '../assets/icons/settings-active.svg'
                  "
                ></span>
              </button>
              <mat-menu #tableSettings="matMenu">
                <div class="table__menu" (click)="$event.stopPropagation()">
                  <div
                    *ngFor="let column of columnsData"
                    class="table__checkbox-container"
                  >
                    <app-checkbox
                      [value]="
                        displayedColumns &&
                        displayedColumns.includes(column.key)
                      "
                      [disabled]="
                        displayedColumns &&
                        displayedColumns.includes(column.key) &&
                        displayedColumns.length <= 1
                      "
                      (valueChange)="
                        onDisplay({ field: column.key, status: $event })
                      "
                      [label]="column.title"
                    ></app-checkbox>
                  </div>
                  <button
                    mat-raised-button
                    color="primary"
                    [disabled]="
                      displayedColumns &&
                      allDisplayedColumns &&
                      displayedColumns.length === allDisplayedColumns.length
                    "
                    (click)="
                      onDisplay({
                        status: true,
                        all: true
                      })
                    "
                  >
                    Выбрать всё
                  </button>
                </div>
              </mat-menu>
            </div>
          </th>
          <th *ngFor="let column of displayedColumns">
            <div class="cell-header__container">
              <div class="cell-header__text">
                {{ findColumnInfo(column) ? findColumnInfo(column).title : '' }}
              </div>
              <div class="cell-header__actions">
                <button
                  (click)="onSort(column)"
                  mat-icon-button
                  class="cell-header__sorting-button"
                  [matTooltip]="'Сортировать'"
                  [matTooltipPosition]="'above'"
                >
                  <span
                    class="icon"
                    [class.desc]="
                      sorting &&
                      sorting.field === column &&
                      sorting.type === 'desc'
                    "
                    [inlineSVG]="
                      sorting && sorting.field !== column
                        ? '../assets/icons/sorting.svg'
                        : '../assets/icons/sorting-active.svg'
                    "
                  ></span>
                </button>

                <button
                  mat-icon-button
                  class="cell-header__filter-button"
                  *ngIf="
                    findColumnInfo(column) && findColumnInfo(column).filter
                  "
                  [matMenuTriggerFor]="tableFilter"
                  [matTooltip]="'Фильтровать'"
                  [matTooltipPosition]="'above'"
                >
                  <!-- Multi-values filter -->
                  <ng-container
                    *ngIf="
                      findColumnInfo(column).filter.type === filterType.values
                    "
                  >
                    <span
                      class="icon"
                      [inlineSVG]="
                        (findFilterInfo(column) &&
                          findFilterInfo(column).value.length <= 0) ||
                        (findFilterInfo(column) &&
                          findFilterInfo(column).value &&
                          findFilterInfo(column).value.length !==
                            findColumnInfo(column).filter.values.length)
                          ? '../assets/icons/funnel-active.svg'
                          : '../assets/icons/funnel.svg'
                      "
                    ></span>
                  </ng-container>

                  <!-- Text filter -->
                  <ng-container
                    *ngIf="
                      findColumnInfo(column).filter.type === filterType.text
                    "
                  >
                    <span
                      class="icon"
                      [inlineSVG]="
                        findFilterInfo(column) && findFilterInfo(column).value
                          ? '../assets/icons/funnel-active.svg'
                          : '../assets/icons/funnel.svg'
                      "
                    ></span>
                  </ng-container>

                  <!-- Number and date filter -->
                  <ng-container
                    *ngIf="
                      findColumnInfo(column).filter.type ===
                        filterType.number ||
                      findColumnInfo(column).filter.type === filterType.date
                    "
                  >
                    <span
                      class="icon"
                      [inlineSVG]="
                        findFilterInfo(column) &&
                        findFilterInfo(column).value &&
                        findFilterInfo(column).value.length > 0
                          ? '../assets/icons/funnel-active.svg'
                          : '../assets/icons/funnel.svg'
                      "
                    ></span>
                  </ng-container>
                </button>

                <mat-menu #tableFilter="matMenu">
                  <div class="table__menu" (click)="$event.stopPropagation()">
                    <!-- Multi-values filter -->
                    <ng-container
                      *ngIf="
                        findColumnInfo(column).filter &&
                        findColumnInfo(column).filter.type === filterType.values
                      "
                    >
                      <div
                        *ngFor="
                          let filterOption of findColumnInfo(column).filter
                            .values
                        "
                        class="table__checkbox-container"
                      >
                        <app-checkbox
                          [value]="
                            (findFilterInfo(column) &&
                              findFilterInfo(column).value.includes(
                                filterOption.value
                              )) ||
                            !findFilterInfo(column)
                          "
                          [disabled]="
                            findFilterInfo(column) &&
                            findFilterInfo(column).value.includes(
                              filterOption.value
                            ) &&
                            findFilterInfo(column).value.length === 1
                          "
                          (valueChange)="
                            onFilter({
                              field: column,
                              type: filterType.values,
                              value: $event,
                              parameter: filterOption.value
                            })
                          "
                          [label]="filterOption.text"
                        ></app-checkbox>
                      </div>

                      <button
                        mat-raised-button
                        color="primary"
                        [disabled]="!findFilterInfo(column)"
                        (click)="
                          onFilter({
                            field: column,
                            type: filterType.values,
                            value: true
                          })
                        "
                      >
                        Выбрать всё
                      </button>
                    </ng-container>

                    <!-- Text filter -->
                    <ng-container
                      *ngIf="
                        findColumnInfo(column) &&
                        findColumnInfo(column).filter &&
                        findColumnInfo(column).filter.type === filterType.text
                      "
                    >
                      <app-text-input
                        label="Поиск..."
                        [value]="
                          column &&
                          findFilterInfo(column) &&
                          findFilterInfo(column).value
                            ? findFilterInfo(column).value
                            : ''
                        "
                        (valueChange)="
                          onFilter({
                            field: column,
                            type: filterType.text,
                            value: $event
                          })
                        "
                      ></app-text-input>

                      <button
                        mat-raised-button
                        color="primary"
                        (click)="
                          onFilter({
                            field: column,
                            type: filterType.text,
                            value: true
                          })
                        "
                      >
                        Очистить
                      </button>
                    </ng-container>

                    <!-- Number filter -->
                    <ng-container
                      *ngIf="
                        findColumnInfo(column) &&
                        findColumnInfo(column).filter &&
                        findColumnInfo(column).filter.type === filterType.number
                      "
                    >
                      <app-text-input
                        fieldType="number"
                        label="от"
                        [value]="
                          column &&
                          findFilterInfo(column) &&
                          findFilterInfo(column).value
                            ? findFilterInfo(column).value[0]
                            : ''
                        "
                        (valueChange)="
                          onFilter({
                            field: column,
                            type: filterType.number,
                            value: $event,
                            parameter: 'from'
                          })
                        "
                      ></app-text-input>
                      <app-text-input
                        fieldType="number"
                        label="до"
                        [value]="
                          column &&
                          findFilterInfo(column) &&
                          findFilterInfo(column).value
                            ? findFilterInfo(column).value[1]
                            : ''
                        "
                        (valueChange)="
                          onFilter({
                            field: column,
                            type: filterType.number,
                            value: $event,
                            parameter: 'to'
                          })
                        "
                      ></app-text-input>

                      <button
                        mat-raised-button
                        color="primary"
                        (click)="
                          onFilter({
                            field: column,
                            type: filterType.number,
                            value: true
                          })
                        "
                      >
                        Очистить
                      </button>
                    </ng-container>

                    <!-- Date filter -->
                    <ng-container
                      *ngIf="
                        findColumnInfo(column) &&
                        findColumnInfo(column).filter &&
                        findColumnInfo(column).filter.type === filterType.date
                      "
                    >
                      <app-date-input
                        label="от"
                        [value]="
                          column &&
                          findFilterInfo(column) &&
                          findFilterInfo(column).value
                            ? findFilterInfo(column).value[0]
                            : ''
                        "
                        (valueChange)="
                          onFilter({
                            field: column,
                            type: filterType.date,
                            value: $event,
                            parameter: 'from'
                          })
                        "
                      ></app-date-input>

                      <app-date-input
                        label="до"
                        [value]="
                          column &&
                          findFilterInfo(column) &&
                          findFilterInfo(column).value
                            ? findFilterInfo(column).value[1]
                            : ''
                        "
                        (valueChange)="
                          onFilter({
                            field: column,
                            type: filterType.date,
                            value: $event,
                            parameter: 'to'
                          })
                        "
                      ></app-date-input>

                      <button
                        mat-raised-button
                        color="primary"
                        (click)="
                          onFilter({
                            field: column,
                            type: filterType.date,
                            value: true
                          })
                        "
                      >
                        Очистить
                      </button>
                    </ng-container>
                  </div>
                </mat-menu>
              </div>
            </div>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let row of data; let i = index" (click)="onItemClick(i)">
          <td style="text-align: center">
            <div class="cell__container">{{ i + 1 }}</div>
          </td>
          <td *ngFor="let column of displayedColumns">
            <div
              class="cell__container"
              [style]="
                columnsData[column]
                  ? 'width: ' + columnsData[column].width + 'px'
                  : undefined
              "
              [innerHTML]="row[column] || '-'"
            ></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <mat-paginator
    *ngIf="pagination"
    [showFirstLastButtons]="true"
    [length]="pagination.totalItemsCount"
    [pageSize]="pagination.perPage"
    [pageIndex]="pagination.currentPage"
    [hidePageSize]="true"
    (page)="onPaginate($event)"
  ></mat-paginator>

  <div *ngIf="isLoading" class="table-loader"></div>
</div>
